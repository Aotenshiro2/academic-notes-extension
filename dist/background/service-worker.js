function D(){setInterval(()=>{chrome.runtime.getPlatformInfo()},2e4)}chrome.runtime.onStartup.addListener(()=>{D()});chrome.runtime.onInstalled.addListener(()=>{console.log("Academic Notes Extension installed"),V(),D()});function V(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"open-sidebar",title:"Ouvrir Trading Notes",contexts:["page","selection"]}),chrome.contextMenus.create({id:"capture-selection",title:"Capturer la sélection",contexts:["selection"]}),chrome.contextMenus.create({id:"capture-page",title:"Capturer cette page",contexts:["page"]}),chrome.contextMenus.create({id:"take-screenshot",title:"Prendre une capture d'écran",contexts:["page"]})})}chrome.contextMenus.onClicked.addListener(async(n,e)=>{if(e!=null&&e.id)switch(n.menuItemId){case"open-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"capture-selection":n.selectionText&&await M(e.id,n.selectionText);break;case"capture-page":await I(e.id);break;case"take-screenshot":await K(e.id);break}});chrome.commands.onCommand.addListener(async(n,e)=>{if(e!=null&&e.id)switch(n){case"toggle-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"quick-capture":await I(e.id);break}});chrome.action.onClicked.addListener(async n=>{if(n.id)try{await chrome.sidePanel.open({tabId:n.id})}catch(e){console.error("Error opening sidepanel:",e)}});chrome.runtime.onMessage.addListener((n,e,t)=>($(n,e,t),!0));async function $(n,e,t){var g;try{const l=((g=e.tab)==null?void 0:g.id)||n.tabId;switch(n.type){case"CAPTURE_CURRENT_PAGE":if(l){const m=await I(l);t(m)}break;case"CAPTURE_SELECTION":if(l){const m=await M(l,n.payload.text);t(m)}break;case"CAPTURE_SCREENSHOT":let x=l;if(!x){const[m]=await chrome.tabs.query({active:!0,currentWindow:!0});x=m==null?void 0:m.id}if(x)try{const m=await chrome.tabs.captureVisibleTab();t({success:!0,dataUrl:m})}catch{t({success:!1,error:"Erreur capture d'écran"})}else t({success:!1,error:"Impossible de trouver l'onglet actif"});break;case"OPEN_SIDEBAR":l&&(await chrome.sidePanel.open({tabId:l}),t({success:!0}));break;case"SMART_CAPTURE":let h=l;if(!h){const[m]=await chrome.tabs.query({active:!0,currentWindow:!0});h=m==null?void 0:m.id}if(h){const m=await B(h);t(m)}else t({success:!1,error:"Impossible de trouver l'onglet actif"});break;case"EXTRACT_CONTENT":if(l){const m=await O(l);t(m)}break;default:t({error:"Unknown message type"})}}catch(l){console.error("Error handling message:",l),t({error:l instanceof Error?l.message:"Unknown error"})}}async function I(n){try{const e=await chrome.tabs.get(n),[{result:t}]=await chrome.scripting.executeScript({target:{tabId:n},func:U});if(!t.success)return{success:!1,error:t.error};const g={id:Date.now().toString(),title:t.title||e.title||"Page sans titre",content:t.content||"",url:e.url||"",favicon:e.favIconUrl,timestamp:Date.now(),type:Y(e.url||"",t.title||""),metadata:{domain:new URL(e.url||"").hostname,title:t.title,description:t.description,author:t.author,publishDate:t.publishDate,ogImage:t.ogImage,siteName:t.siteName,language:t.language},tags:[],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(n,{type:"SAVE_NOTE",payload:{note:g}}),{success:!0,note:g}}catch(e){return console.error("Error capturing page:",e),{success:!1,error:e instanceof Error?e.message:"Erreur de capture"}}}async function M(n,e){try{const t=await chrome.tabs.get(n),g={id:Date.now().toString(),title:`Sélection - ${t.title||"Page"}`,content:e,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["sélection"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(n,{type:"SAVE_NOTE",payload:{note:g}}),{success:!0,note:g}}catch(t){return console.error("Error capturing selection:",t),{success:!1,error:"Erreur capture sélection"}}}async function K(n){try{const e=await chrome.tabs.captureVisibleTab(),t=await chrome.tabs.get(n),g={id:Date.now().toString(),title:`Capture d'écran - ${t.title||"Page"}`,content:`![Capture d'écran](${e})`,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["capture"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(n,{type:"SAVE_NOTE",payload:{note:g}}),{success:!0,note:g}}catch(e){return console.error("Error taking screenshot:",e),{success:!1,error:"Erreur capture d'écran"}}}async function O(n){try{const[{result:e}]=await chrome.scripting.executeScript({target:{tabId:n},func:U});return e}catch(e){return{success:!1,error:e instanceof Error?e.message:"Erreur extraction"}}}function U(){var n,e,t,g,l,x,h,m,w,s,d;try{let p="",C="",A="",E="",o="",a="",f="",v=document.documentElement.lang||"fr";C=document.title;const P=(n=document.querySelector('meta[property="og:title"]'))==null?void 0:n.getAttribute("content"),u=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),r=(t=document.querySelector('meta[property="og:image"]'))==null?void 0:t.getAttribute("content"),S=(g=document.querySelector('meta[property="og:site_name"]'))==null?void 0:g.getAttribute("content"),b=(l=document.querySelector('meta[name="description"]'))==null?void 0:l.getAttribute("content"),L=(x=document.querySelector('meta[name="author"]'))==null?void 0:x.getAttribute("content"),c=(h=document.querySelector('meta[name="twitter:description"]'))==null?void 0:h.getAttribute("content");C=P||C,A=u||b||c||"",E=L||"",a=r||"",f=S||"";const i=['meta[property="article:published_time"]','meta[name="publication_date"]','meta[name="date"]',"time[datetime]","[datetime]"];for(const T of i){const k=document.querySelector(T);if(k){o=k.getAttribute("content")||k.getAttribute("datetime")||k.textContent||"";break}}const y=["article","main",'[role="main"]',".post-content",".entry-content",".article-content",".blog-content",".blog-post",".post-body",".post",".content",".main-content",".page-content",".story-content",".single-content","#content","#main","#main-content","#post","#article","#post-content",'[itemprop="articleBody"]','[itemprop="text"]',".wp-content",".the-content",".section-content",".post-full-content"];let q=null;for(const T of y){if(q=document.querySelector(T),q&&q.textContent&&q.textContent.trim().length>100)break;q=null}if(q){const T=q.cloneNode(!0);["script","style","nav","header","footer","aside",".ads",".advertisement",".social",".share",".sidebar",".comments",".comment",".related",".recommended",'[class*="ad-"]','[class*="ads-"]','[id*="ad-"]',"#secondary","#related","#comments",".ytd-compact-video-renderer",".ytd-watch-next-secondary-results-renderer",'[class*="ytp-endscreen"]',".ytd-item-section-renderer",".ytd-shelf-renderer","#playlist",".ytd-merch-shelf-renderer",".ytd-watch-flexy #secondary-inner",".ytd-watch-next-secondary-results-renderer"].forEach(N=>{try{T.querySelectorAll(N).forEach(_=>_.remove())}catch{}}),p=((m=T.textContent)==null?void 0:m.trim())||""}if(!p||p.length<100){const T=document.body.cloneNode(!0);T.querySelectorAll("script, style, nav, header, footer, aside, noscript, iframe, svg, img, video, audio").forEach(N=>N.remove());const k=document.createElement("div");k.innerHTML=T.innerHTML,document.body.appendChild(k),p=((w=k.innerText)==null?void 0:w.trim())||"",k.remove(),(!p||p.length<50)&&(p=((s=document.body.innerText)==null?void 0:s.trim())||"")}return p.length>15e3&&(p=p.substring(0,15e3)+"..."),{success:!0,title:C,content:p,description:A,author:E,publishDate:o,ogImage:a,siteName:f,language:v}}catch(p){try{return{success:!0,title:document.title,content:((d=document.body.innerText)==null?void 0:d.substring(0,15e3))||"",description:"",author:"",publishDate:"",ogImage:"",siteName:"",language:"fr"}}catch{return{success:!1,error:p instanceof Error?p.message:"Erreur extraction contenu"}}}}function z(){var n,e,t,g,l,x,h,m,w;try{const s=(n=document.querySelector('meta[name="description"]'))==null?void 0:n.getAttribute("content"),d=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),p=document.querySelectorAll("article p, main p, .content p, .post-content p, .entry-content p, p");let C="";for(const c of p){const i=((t=c.textContent)==null?void 0:t.trim())||"";if(i.length>80){C=i.slice(0,400);break}}const A=d||s||C||document.title,E=document.querySelector("article")||document.querySelector("main")||document.querySelector('[role="main"]')||document.querySelector(".post-content")||document.querySelector(".entry-content")||document.querySelector(".article-content")||document.querySelector(".blog-content")||document.querySelector("#content"),o=["related","comments","share","subscribe","newsletter","suivez","partager","also read","see also","à lire","menu","navigation","footer","header","sidebar","contact","about","à propos","instagram","facebook","twitter","tiktok","linkedin","youtube","pinterest","snapchat","discord","whatsapp","telegram","publications recommandées","articles similaires","articles récents","recommended","popular posts","trending","recent posts","archives","catégories","categories","tags","recherche","search","widget"],a=c=>{const i=c.toLowerCase();return o.some(y=>i.includes(y))};let f=[];if(E&&(f=Array.from(E.querySelectorAll("h2, h3")).map(c=>{var i;return(i=c.textContent)==null?void 0:i.trim()}).filter(c=>!!c&&c.length>5&&c.length<150&&!a(c)).slice(0,8)),f.length===0){const c=(E||document).querySelectorAll("p");f=Array.from(c).map(i=>{var y;return(y=i.textContent)==null?void 0:y.trim()}).filter(i=>!!i&&i.length>80&&!a(i)).slice(0,5).map(i=>{var q;const y=(q=i.match(/^[^.!?]+[.!?]/))==null?void 0:q[0];return(y==null?void 0:y.trim())||i.slice(0,120)+"..."})}const v=Array.from(document.querySelectorAll("article strong, article b, main strong, main b, .content strong, .content b")).map(c=>{var i;return(i=c.textContent)==null?void 0:i.trim()}).filter(c=>!!c&&c.length>2&&c.length<60),P=Array.from(document.querySelectorAll("article a, main a, .content a")).map(c=>{var i;return(i=c.textContent)==null?void 0:i.trim()}).filter(c=>!!c&&c.length>3&&c.length<50&&!c.startsWith("http")),u=[...new Set([...v,...P])].slice(0,10),r=(g=document.querySelector('meta[name="keywords"]'))==null?void 0:g.getAttribute("content");let S=[];if(r&&(S=r.split(",").map(c=>c.trim().toLowerCase()).filter(c=>c.length>1&&c.length<30)),S.length===0){const c=document.querySelectorAll('.tag, .tags a, .category, .categories a, [rel="tag"]');S=Array.from(c).map(i=>{var y;return(y=i.textContent)==null?void 0:y.trim().toLowerCase()}).filter(i=>!!i&&i.length>1&&i.length<30)}S=[...new Set(S)].slice(0,6);let b="";const L=["article","main",'[role="main"]',".post-content",".entry-content",".content","#content"];for(const c of L){const i=document.querySelector(c);if(i){const y=i.cloneNode(!0);if(["script","style","nav","aside","footer",".ads",".comments","#secondary","#related",".ytd-compact-video-renderer",".ytd-watch-next-secondary-results-renderer",'[class*="ytp-endscreen"]',".ytd-item-section-renderer",".ytd-shelf-renderer","#playlist",".ytd-merch-shelf-renderer"].forEach(T=>{try{y.querySelectorAll(T).forEach(k=>k.remove())}catch{}}),b=((l=y.textContent)==null?void 0:l.trim())||"",b.length>100)break}}return(!b||b.length<100)&&(b=((x=document.body.innerText)==null?void 0:x.trim())||""),b.length>1e4&&(b=b.substring(0,1e4)+"..."),{success:!0,title:document.title,content:b,summary:A,keyPoints:f,concepts:u,tags:S,description:d||s||"",author:((h=document.querySelector('meta[name="author"]'))==null?void 0:h.getAttribute("content"))||"",ogImage:((m=document.querySelector('meta[property="og:image"]'))==null?void 0:m.getAttribute("content"))||"",siteName:((w=document.querySelector('meta[property="og:site_name"]'))==null?void 0:w.getAttribute("content"))||""}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Erreur extraction"}}}async function B(n){var e,t,g,l,x;try{const h=await chrome.tabs.get(n),m=h.url||"",w=m.includes("youtube.com/watch")||m.includes("youtu.be/");let s=h.title||"Page sans titre",d="",p="",C=[],A=[],E=[],o="",a="",f="",v="";if(w)try{const u=await chrome.scripting.executeScript({target:{tabId:n},func:R}),r=(e=u==null?void 0:u[0])==null?void 0:e.result;r&&(s=r.title||s,a=r.author||"",o=r.description||"",r.chapters&&r.chapters.length>0?C=r.chapters.slice(0,8):r.transcriptKeyPoints&&r.transcriptKeyPoints.length>0?C=r.transcriptKeyPoints:r.descriptionKeyPoints&&r.descriptionKeyPoints.length>0&&(C=r.descriptionKeyPoints),d=r.transcript||r.description||"",p=a?`Vidéo de ${a}: ${s}`:s)}catch(u){console.warn("YouTube extraction failed:",u)}if(!w&&(!d||d.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:n},func:z}),r=(t=u==null?void 0:u[0])==null?void 0:t.result;r!=null&&r.success&&(s=r.title||s,d=r.content||"",p=r.summary||"",C=r.keyPoints||[],A=r.concepts||[],E=r.tags||[],o=r.description||"",a=r.author||"",f=r.ogImage||"",v=r.siteName||"")}catch(u){console.warn("Structured extraction failed:",u)}if(!w&&(!d||d.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:n},func:()=>{var S,b;return{text:((b=(S=document.body)==null?void 0:S.innerText)==null?void 0:b.trim())||"",title:document.title}}}),r=(g=u==null?void 0:u[0])==null?void 0:g.result;r!=null&&r.text&&r.text.length>50&&(d=r.text.substring(0,1e4),s=r.title||s,p=d.slice(0,300))}catch(u){console.warn("Simple extraction failed:",u)}if(w&&(!d||d.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:n},func:()=>{var c,i,y,q,T;const S=(c=document.querySelector('meta[property="og:title"]'))==null?void 0:c.getAttribute("content"),b=(i=document.querySelector('meta[property="og:description"]'))==null?void 0:i.getAttribute("content"),L=((y=document.querySelector('link[itemprop="name"]'))==null?void 0:y.getAttribute("content"))||((T=(q=document.querySelector("#channel-name"))==null?void 0:q.textContent)==null?void 0:T.trim());return{ogTitle:S,ogDesc:b,channelName:L}}}),r=(l=u==null?void 0:u[0])==null?void 0:l.result;r&&(s=r.ogTitle||s,o=r.ogDesc||o,a=r.channelName||a,d=o||s,p=a?`Vidéo de ${a}: ${s}`:`Vidéo YouTube: ${s}`)}catch(u){console.warn("YouTube meta extraction failed:",u)}if(w&&(!d||d.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:n},func:()=>{var c,i,y;const S=document.title;if(S&&S!=="YouTube"&&S.length>8)return S.replace(/\s*-\s*YouTube$/i,"").trim();const b=(c=document.querySelector('meta[property="og:title"]'))==null?void 0:c.getAttribute("content");if(b)return b;const L=(y=(i=document.querySelector("h1"))==null?void 0:i.textContent)==null?void 0:y.trim();return L&&L!=="YouTube"&&L.length>3?L:null}}),r=(x=u==null?void 0:u[0])==null?void 0:x.result;r&&(s=r,d=r,p=`Vidéo YouTube: ${r}`)}catch(u){console.warn("YouTube title extraction failed:",u)}if(w&&(!s||s==="YouTube"||s==="Page sans titre")&&(p="Vidéo YouTube (titre non disponible - attendez le chargement complet)",d=p,s="Vidéo YouTube"),!w&&(!d||d.length<50))return{success:!1,error:"Contenu insuffisant. Vérifiez que la page est bien chargée."};let P="";try{P=new URL(m).hostname.replace("www.","")}catch{}return{success:!0,content:d,pageTitle:s,url:m,favicon:h.favIconUrl||"",domain:P,isYouTube:w,contentType:Y(m,s),summary:p,keyPoints:C,concepts:A,tags:E,description:o,author:a,ogImage:f,siteName:v}}catch(h){return console.error("Error in smart capture:",h),{success:!1,error:h instanceof Error?h.message:"Erreur lors de la capture intelligente"}}}function R(){var n,e,t,g;try{let l="";const x=document.querySelector("h1.ytd-watch-metadata yt-formatted-string")||document.querySelector("#title h1")||document.querySelector("h1.title")||document.querySelector('[itemprop="name"]');if((n=x==null?void 0:x.textContent)!=null&&n.trim()&&(l=x.textContent.trim()),!l){const o=(e=document.querySelector('meta[property="og:title"]'))==null?void 0:e.getAttribute("content");o&&(l=o)}if(!l){const o=document.title;o&&o!=="YouTube"&&o.length>8&&(l=o.replace(/\s*-\s*YouTube$/i,"").trim())}l||(l="");const h=document.querySelector("#channel-name a")||document.querySelector(".ytd-channel-name a"),m=((t=h==null?void 0:h.textContent)==null?void 0:t.trim())||"",w=document.querySelector("#description-inline-expander yt-formatted-string")||document.querySelector("#description yt-formatted-string")||document.querySelector("#description"),s=((g=w==null?void 0:w.textContent)==null?void 0:g.trim())||"";let d="";const p=document.querySelectorAll("ytd-transcript-segment-renderer .segment-text,ytd-transcript-segment-renderer yt-formatted-string");if(p.length>0&&(d=Array.from(p).map(o=>{var a;return(a=o.textContent)==null?void 0:a.trim()}).filter(Boolean).join(" ")),!d){const o=document.querySelectorAll(".captions-text, .ytp-caption-segment");o.length>0&&(d=Array.from(o).map(a=>{var f;return(f=a.textContent)==null?void 0:f.trim()}).filter(Boolean).join(" "))}const C=[];if(s){const o=/(?:\[?\d{1,2}:\d{2}(?::\d{2})?\]?\s*[-–]?\s*)([^\n]+)/g;let a;for(;(a=o.exec(s))!==null;){const f=a[1].trim();f.length>3&&f.length<100&&C.push(f)}}let A=[];if(d&&d.length>200){const o=d.split(/[.!?]+/).map(a=>a.trim()).filter(a=>a.length>40&&a.length<200&&!a.toLowerCase().includes("subscribe")&&!a.toLowerCase().includes("like this video")&&!a.toLowerCase().includes("click the bell")&&!a.toLowerCase().includes("hit the like")&&!a.toLowerCase().includes("leave a comment")&&!a.toLowerCase().includes("check out my")&&!a.toLowerCase().includes("link in the description")&&!a.toLowerCase().includes("abonnez")&&!a.toLowerCase().includes("likez"));if(o.length>0){const a=Math.max(1,Math.floor(o.length/5));for(let f=0;f<o.length&&A.length<5;f+=a)A.push(o[f].slice(0,150))}}let E=[];return s&&A.length===0&&C.length===0&&(E=s.split(`
`).map(o=>o.trim()).filter(o=>o.length>30&&o.length<150&&!o.startsWith("http")&&!o.match(/^\d{1,2}:\d{2}/)&&!o.toLowerCase().includes("subscribe")&&!o.toLowerCase().includes("follow me")&&!o.toLowerCase().includes("instagram")&&!o.toLowerCase().includes("twitter")&&!o.toLowerCase().includes("discord")&&!o.toLowerCase().includes("patreon")).slice(0,5)),{title:l,author:m,description:s,transcript:d||"",chapters:C,transcriptKeyPoints:A,descriptionKeyPoints:E}}catch{return{title:document.title,author:"",description:"",transcript:"",chapters:[],transcriptKeyPoints:[]}}}function Y(n,e){return n.includes(".pdf")?"pdf":n.includes("youtube.com")||n.includes("youtu.be")?"video":e.toLowerCase().includes("research")||e.toLowerCase().includes("study")||e.toLowerCase().includes("journal")?"research-paper":n.includes("docs.")||n.includes("documentation")?"documentation":n.includes("article")||n.includes("blog")?"article":"webpage"}D();
