function I(){setInterval(()=>{chrome.runtime.getPlatformInfo()},2e4)}chrome.runtime.onStartup.addListener(()=>{I()});chrome.runtime.onInstalled.addListener(()=>{console.log("Academic Notes Extension installed"),$(),I()});function $(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"open-sidebar",title:"Ouvrir Trading Notes",contexts:["page","selection"]}),chrome.contextMenus.create({id:"capture-selection",title:"Capturer la sélection",contexts:["selection"]}),chrome.contextMenus.create({id:"capture-page",title:"Capturer cette page",contexts:["page"]}),chrome.contextMenus.create({id:"take-screenshot",title:"Prendre une capture d'écran",contexts:["page"]})})}chrome.contextMenus.onClicked.addListener(async(r,e)=>{if(e!=null&&e.id)switch(r.menuItemId){case"open-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"capture-selection":r.selectionText&&await D(e.id,r.selectionText);break;case"capture-page":await N(e.id);break;case"take-screenshot":await L(e.id);break}});chrome.commands.onCommand.addListener(async(r,e)=>{if(e!=null&&e.id)switch(r){case"toggle-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"quick-capture":await N(e.id);break}});chrome.action.onClicked.addListener(async r=>{if(r.id)try{await chrome.sidePanel.open({tabId:r.id})}catch(e){console.error("Error opening sidepanel:",e)}});chrome.runtime.onMessage.addListener((r,e,t)=>(B(r,e,t),!0));async function B(r,e,t){var i;try{const a=((i=e.tab)==null?void 0:i.id)||r.tabId;switch(r.type){case"CAPTURE_CURRENT_PAGE":if(a){const n=await N(a);t(n)}break;case"CAPTURE_SELECTION":if(a){const n=await D(a,r.payload.text);t(n)}break;case"CAPTURE_SCREENSHOT":let m=a;if(!m){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});m=n==null?void 0:n.id}if(m)if(r.options){const n=await R(m,r.options);t(n)}else{const n=await L(m);t(n)}else t({success:!1,error:"Impossible de trouver l'onglet actif"});break;case"OPEN_SIDEBAR":a&&(await chrome.sidePanel.open({tabId:a}),t({success:!0}));break;case"SMART_CAPTURE":let g=a;if(!g){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});g=n==null?void 0:n.id}if(g){const n=await H(g);t(n)}else t({success:!1,error:"Impossible de trouver l'onglet actif"});break;case"EXTRACT_CONTENT":if(a){const n=await Y(a);t(n)}break;default:t({error:"Unknown message type"})}}catch(a){console.error("Error handling message:",a),t({error:a instanceof Error?a.message:"Unknown error"})}}async function N(r){try{const e=await chrome.tabs.get(r),[{result:t}]=await chrome.scripting.executeScript({target:{tabId:r},func:U});if(!t.success)return{success:!1,error:t.error};const i={id:Date.now().toString(),title:t.title||e.title||"Page sans titre",content:t.content||"",url:e.url||"",favicon:e.favIconUrl,timestamp:Date.now(),type:M(e.url||"",t.title||""),metadata:{domain:new URL(e.url||"").hostname,title:t.title,description:t.description,author:t.author,publishDate:t.publishDate,ogImage:t.ogImage,siteName:t.siteName,language:t.language},tags:[],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:i}}),{success:!0,note:i}}catch(e){return console.error("Error capturing page:",e),{success:!1,error:e instanceof Error?e.message:"Erreur de capture"}}}async function D(r,e){try{const t=await chrome.tabs.get(r),i={id:Date.now().toString(),title:`Sélection - ${t.title||"Page"}`,content:e,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["sélection"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:i}}),{success:!0,note:i}}catch(t){return console.error("Error capturing selection:",t),{success:!1,error:"Erreur capture sélection"}}}async function L(r){try{const e=await chrome.tabs.captureVisibleTab(),t=await chrome.tabs.get(r),i={id:Date.now().toString(),title:`Capture d'écran - ${t.title||"Page"}`,content:`![Capture d'écran](${e})`,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["capture"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:i}}),{success:!0,note:i}}catch(e){return console.error("Error taking screenshot:",e),{success:!1,error:"Erreur capture d'écran"}}}async function R(r,e){try{return{success:!0,dataUrl:await chrome.tabs.captureVisibleTab(),message:"Screenshot captured successfully"}}catch(t){return console.error("Error capturing screenshot for note:",t),{success:!1,error:t instanceof Error?t.message:"Erreur capture d'écran"}}}async function Y(r){try{const[{result:e}]=await chrome.scripting.executeScript({target:{tabId:r},func:U});return e}catch(e){return{success:!1,error:e instanceof Error?e.message:"Erreur extraction"}}}function U(){var r,e,t,i,a,m,g,n,d,p,y;try{let s="",h="",b="",S="",E="",C="",A="",l=document.documentElement.lang||"fr";h=document.title;const o=(r=document.querySelector('meta[property="og:title"]'))==null?void 0:r.getAttribute("content"),f=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),k=(t=document.querySelector('meta[property="og:image"]'))==null?void 0:t.getAttribute("content"),c=(i=document.querySelector('meta[property="og:site_name"]'))==null?void 0:i.getAttribute("content"),u=(a=document.querySelector('meta[name="description"]'))==null?void 0:a.getAttribute("content"),q=(m=document.querySelector('meta[name="author"]'))==null?void 0:m.getAttribute("content"),v=(g=document.querySelector('meta[name="twitter:description"]'))==null?void 0:g.getAttribute("content");h=o||h,b=f||u||v||"",S=q||"",C=k||"",A=c||"";const _=['meta[property="article:published_time"]','meta[name="publication_date"]','meta[name="date"]',"time[datetime]","[datetime]"];for(const x of _){const w=document.querySelector(x);if(w){E=w.getAttribute("content")||w.getAttribute("datetime")||w.textContent||"";break}}const O=["article","main",'[role="main"]',".post-content",".entry-content",".article-content",".blog-content",".blog-post",".post-body",".post",".content",".main-content",".page-content",".story-content",".single-content","#content","#main","#main-content","#post","#article","#post-content",'[itemprop="articleBody"]','[itemprop="text"]',".wp-content",".the-content",".section-content",".post-full-content"];let T=null;for(const x of O){if(T=document.querySelector(x),T&&T.textContent&&T.textContent.trim().length>100)break;T=null}if(T){const x=T.cloneNode(!0);["script","style","nav","header","footer","aside",".ads",".advertisement",".social",".share",".sidebar",".comments",".comment",".related",".recommended",'[class*="ad-"]','[class*="ads-"]','[id*="ad-"]'].forEach(P=>{try{x.querySelectorAll(P).forEach(V=>V.remove())}catch{}}),s=((n=x.textContent)==null?void 0:n.trim())||""}if(!s||s.length<100){const x=document.body.cloneNode(!0);x.querySelectorAll("script, style, nav, header, footer, aside, noscript, iframe, svg, img, video, audio").forEach(P=>P.remove());const w=document.createElement("div");w.innerHTML=x.innerHTML,document.body.appendChild(w),s=((d=w.innerText)==null?void 0:d.trim())||"",w.remove(),(!s||s.length<50)&&(s=((p=document.body.innerText)==null?void 0:p.trim())||"")}return s.length>15e3&&(s=s.substring(0,15e3)+"..."),{success:!0,title:h,content:s,description:b,author:S,publishDate:E,ogImage:C,siteName:A,language:l}}catch(s){try{return{success:!0,title:document.title,content:((y=document.body.innerText)==null?void 0:y.substring(0,15e3))||"",description:"",author:"",publishDate:"",ogImage:"",siteName:"",language:"fr"}}catch{return{success:!1,error:s instanceof Error?s.message:"Erreur extraction contenu"}}}}function j(){var r,e,t,i,a,m,g,n,d;try{const p=(r=document.querySelector('meta[name="description"]'))==null?void 0:r.getAttribute("content"),y=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),s=document.querySelectorAll("article p, main p, .content p, .post-content p, .entry-content p, p");let h="";for(const c of s){const u=((t=c.textContent)==null?void 0:t.trim())||"";if(u.length>80){h=u.slice(0,400);break}}const b=y||p||h||document.title,S=Array.from(document.querySelectorAll("article h2, article h3, main h2, main h3, .content h2, .content h3, h2, h3")).map(c=>{var u;return(u=c.textContent)==null?void 0:u.trim()}).filter(c=>!!c&&c.length>3&&c.length<150).slice(0,8),E=Array.from(document.querySelectorAll("article strong, article b, main strong, main b, .content strong, .content b")).map(c=>{var u;return(u=c.textContent)==null?void 0:u.trim()}).filter(c=>!!c&&c.length>2&&c.length<60),C=Array.from(document.querySelectorAll("article a, main a, .content a")).map(c=>{var u;return(u=c.textContent)==null?void 0:u.trim()}).filter(c=>!!c&&c.length>3&&c.length<50&&!c.startsWith("http")),A=[...new Set([...E,...C])].slice(0,10),l=(i=document.querySelector('meta[name="keywords"]'))==null?void 0:i.getAttribute("content");let o=[];if(l&&(o=l.split(",").map(c=>c.trim().toLowerCase()).filter(c=>c.length>1&&c.length<30)),o.length===0){const c=document.querySelectorAll('.tag, .tags a, .category, .categories a, [rel="tag"]');o=Array.from(c).map(u=>{var q;return(q=u.textContent)==null?void 0:q.trim().toLowerCase()}).filter(u=>!!u&&u.length>1&&u.length<30)}o=[...new Set(o)].slice(0,6);let f="";const k=["article","main",'[role="main"]',".post-content",".entry-content",".content","#content"];for(const c of k){const u=document.querySelector(c);if(u){const q=u.cloneNode(!0);if(q.querySelectorAll("script, style, nav, aside, footer, .ads, .comments").forEach(v=>v.remove()),f=((a=q.textContent)==null?void 0:a.trim())||"",f.length>100)break}}return(!f||f.length<100)&&(f=((m=document.body.innerText)==null?void 0:m.trim())||""),f.length>1e4&&(f=f.substring(0,1e4)+"..."),{success:!0,title:document.title,content:f,summary:b,keyPoints:S,concepts:A,tags:o,description:y||p||"",author:((g=document.querySelector('meta[name="author"]'))==null?void 0:g.getAttribute("content"))||"",ogImage:((n=document.querySelector('meta[property="og:image"]'))==null?void 0:n.getAttribute("content"))||"",siteName:((d=document.querySelector('meta[property="og:site_name"]'))==null?void 0:d.getAttribute("content"))||""}}catch(p){return{success:!1,error:p instanceof Error?p.message:"Erreur extraction"}}}async function H(r){var e,t,i;try{const a=await chrome.tabs.get(r),m=a.url||"",g=m.includes("youtube.com/watch")||m.includes("youtu.be/");let n=a.title||"Page sans titre",d="",p="",y=[],s=[],h=[],b="",S="",E="",C="";if(g)try{const l=await chrome.scripting.executeScript({target:{tabId:r},func:W}),o=(e=l==null?void 0:l[0])==null?void 0:e.result;o&&(n=o.title||n,S=o.author||"",o.transcript?(d=o.transcript,p=`Vidéo de ${S}: ${n}`,y=["Transcription disponible"]):o.description&&(d=o.description,p=o.description.slice(0,300),y=["Pas de transcription - description extraite"]))}catch(l){console.warn("YouTube extraction failed:",l)}if(!d||d.length<50)try{const l=await chrome.scripting.executeScript({target:{tabId:r},func:j}),o=(t=l==null?void 0:l[0])==null?void 0:t.result;o!=null&&o.success&&(n=o.title||n,d=o.content||"",p=o.summary||"",y=o.keyPoints||[],s=o.concepts||[],h=o.tags||[],b=o.description||"",S=o.author||"",E=o.ogImage||"",C=o.siteName||"")}catch(l){console.warn("Structured extraction failed:",l)}if(!d||d.length<50)try{const l=await chrome.scripting.executeScript({target:{tabId:r},func:()=>{var f,k;return{text:((k=(f=document.body)==null?void 0:f.innerText)==null?void 0:k.trim())||"",title:document.title}}}),o=(i=l==null?void 0:l[0])==null?void 0:i.result;o!=null&&o.text&&o.text.length>50&&(d=o.text.substring(0,1e4),n=o.title||n,p=d.slice(0,300))}catch(l){console.warn("Simple extraction failed:",l)}if(!d||d.length<50)return{success:!1,error:"Contenu insuffisant. Vérifiez que la page est bien chargée."};let A="";try{A=new URL(m).hostname.replace("www.","")}catch{}return{success:!0,content:d,pageTitle:n,url:m,favicon:a.favIconUrl||"",domain:A,isYouTube:g,contentType:M(m,n),summary:p,keyPoints:y,concepts:s,tags:h,description:b,author:S,ogImage:E,siteName:C}}catch(a){return console.error("Error in smart capture:",a),{success:!1,error:a instanceof Error?a.message:"Erreur lors de la capture intelligente"}}}function W(){var r,e,t;try{const i=document.querySelector("h1.ytd-watch-metadata yt-formatted-string")||document.querySelector("#title h1"),a=((r=i==null?void 0:i.textContent)==null?void 0:r.trim())||document.title.replace(" - YouTube",""),m=document.querySelector("#channel-name a")||document.querySelector(".ytd-channel-name a"),g=((e=m==null?void 0:m.textContent)==null?void 0:e.trim())||"",n=document.querySelector("#description-inline-expander yt-formatted-string")||document.querySelector("#description yt-formatted-string")||document.querySelector("#description"),d=((t=n==null?void 0:n.textContent)==null?void 0:t.trim())||"";let p="";const y=document.querySelectorAll("ytd-transcript-segment-renderer .segment-text,ytd-transcript-segment-renderer yt-formatted-string");if(y.length>0&&(p=Array.from(y).map(s=>{var h;return(h=s.textContent)==null?void 0:h.trim()}).filter(Boolean).join(" ")),!p){const s=document.querySelectorAll(".captions-text, .ytp-caption-segment");s.length>0&&(p=Array.from(s).map(h=>{var b;return(b=h.textContent)==null?void 0:b.trim()}).filter(Boolean).join(" "))}return{title:a,author:g,description:d,transcript:p||""}}catch{return{title:document.title,author:"",description:"",transcript:""}}}function M(r,e){return r.includes(".pdf")?"pdf":r.includes("youtube.com")||r.includes("youtu.be")?"video":e.toLowerCase().includes("research")||e.toLowerCase().includes("study")||e.toLowerCase().includes("journal")?"research-paper":r.includes("docs.")||r.includes("documentation")?"documentation":r.includes("article")||r.includes("blog")?"article":"webpage"}I();
