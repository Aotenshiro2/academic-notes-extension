function N(){setInterval(()=>{chrome.runtime.getPlatformInfo()},2e4)}chrome.runtime.onStartup.addListener(()=>{N()});chrome.runtime.onInstalled.addListener(()=>{console.log("Academic Notes Extension installed"),V(),N()});function V(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"open-sidebar",title:"Ouvrir Trading Notes",contexts:["page","selection"]}),chrome.contextMenus.create({id:"capture-selection",title:"Capturer la sélection",contexts:["selection"]}),chrome.contextMenus.create({id:"capture-page",title:"Capturer cette page",contexts:["page"]}),chrome.contextMenus.create({id:"take-screenshot",title:"Prendre une capture d'écran",contexts:["page"]})})}chrome.contextMenus.onClicked.addListener(async(r,e)=>{if(e!=null&&e.id)switch(r.menuItemId){case"open-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"capture-selection":r.selectionText&&await M(e.id,r.selectionText);break;case"capture-page":await D(e.id);break;case"take-screenshot":await K(e.id);break}});chrome.commands.onCommand.addListener(async(r,e)=>{if(e!=null&&e.id)switch(r){case"toggle-sidebar":await chrome.sidePanel.open({tabId:e.id});break;case"quick-capture":await D(e.id);break}});chrome.action.onClicked.addListener(async r=>{if(r.id)try{await chrome.sidePanel.open({tabId:r.id})}catch(e){console.error("Error opening sidepanel:",e)}});chrome.runtime.onMessage.addListener((r,e,t)=>($(r,e,t),!0));async function $(r,e,t){var h,w;try{const g=r.tabId||((h=e.tab)==null?void 0:h.id);switch(r.type){case"CAPTURE_CURRENT_PAGE":if(g){const p=await D(g);t(p)}break;case"CAPTURE_SELECTION":if(g){const p=await M(g,r.payload.text);t(p)}break;case"CAPTURE_SCREENSHOT":{const p=(w=r.payload)==null?void 0:w.targetTabId;if(p)try{const m=e.tab,l=(await chrome.tabs.get(p)).windowId;await chrome.tabs.update(p,{active:!0}),await chrome.windows.update(l,{focused:!0}),await new Promise(S=>setTimeout(S,350));const d=await chrome.tabs.captureVisibleTab(l);m!=null&&m.id&&(await chrome.tabs.update(m.id,{active:!0}),m.windowId!==l&&await chrome.windows.update(m.windowId,{focused:!0})),t({success:!0,dataUrl:d})}catch(m){console.error("Targeted screenshot failed:",m),t({success:!1,error:"Erreur capture d'écran ciblée"})}else{let m=g;if(!m){const[c]=await chrome.tabs.query({active:!0,currentWindow:!0});m=c==null?void 0:c.id}if(m)try{const c=await chrome.tabs.captureVisibleTab();t({success:!0,dataUrl:c})}catch{t({success:!1,error:"Erreur capture d'écran"})}else t({success:!1,error:"Impossible de trouver l'onglet actif"})}break}case"OPEN_SIDEBAR":g&&(await chrome.sidePanel.open({tabId:g}),t({success:!0}));break;case"SMART_CAPTURE":let y=g;if(!y){const[p]=await chrome.tabs.query({active:!0,currentWindow:!0});y=p==null?void 0:p.id}if(y){const p=await B(y);t(p)}else t({success:!1,error:"Impossible de trouver l'onglet actif"});break;case"EXTRACT_CONTENT":if(g){const p=await O(g);t(p)}break;default:t({error:"Unknown message type"})}}catch(g){console.error("Error handling message:",g),t({error:g instanceof Error?g.message:"Unknown error"})}}async function D(r){try{const e=await chrome.tabs.get(r),[{result:t}]=await chrome.scripting.executeScript({target:{tabId:r},func:U});if(!t.success)return{success:!1,error:t.error};const h={id:Date.now().toString(),title:t.title||e.title||"Page sans titre",content:t.content||"",url:e.url||"",favicon:e.favIconUrl,timestamp:Date.now(),type:Y(e.url||"",t.title||""),metadata:{domain:new URL(e.url||"").hostname,title:t.title,description:t.description,author:t.author,publishDate:t.publishDate,ogImage:t.ogImage,siteName:t.siteName,language:t.language},tags:[],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:h}}),{success:!0,note:h}}catch(e){return console.error("Error capturing page:",e),{success:!1,error:e instanceof Error?e.message:"Erreur de capture"}}}async function M(r,e){try{const t=await chrome.tabs.get(r),h={id:Date.now().toString(),title:`Sélection - ${t.title||"Page"}`,content:e,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["sélection"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:h}}),{success:!0,note:h}}catch(t){return console.error("Error capturing selection:",t),{success:!1,error:"Erreur capture sélection"}}}async function K(r){try{const e=await chrome.tabs.captureVisibleTab(),t=await chrome.tabs.get(r),h={id:Date.now().toString(),title:`Capture d'écran - ${t.title||"Page"}`,content:`![Capture d'écran](${e})`,url:t.url||"",favicon:t.favIconUrl,timestamp:Date.now(),type:"webpage",metadata:{domain:new URL(t.url||"").hostname,title:t.title},tags:["capture"],concepts:[],screenshots:[]};return await chrome.tabs.sendMessage(r,{type:"SAVE_NOTE",payload:{note:h}}),{success:!0,note:h}}catch(e){return console.error("Error taking screenshot:",e),{success:!1,error:"Erreur capture d'écran"}}}async function O(r){try{const[{result:e}]=await chrome.scripting.executeScript({target:{tabId:r},func:U});return e}catch(e){return{success:!1,error:e instanceof Error?e.message:"Erreur extraction"}}}function U(){var r,e,t,h,w,g,y,p,m,c,l;try{let d="",S="",A="",E="",o="",i="",b="",L=document.documentElement.lang||"fr";S=document.title;const P=(r=document.querySelector('meta[property="og:title"]'))==null?void 0:r.getAttribute("content"),u=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),n=(t=document.querySelector('meta[property="og:image"]'))==null?void 0:t.getAttribute("content"),C=(h=document.querySelector('meta[property="og:site_name"]'))==null?void 0:h.getAttribute("content"),x=(w=document.querySelector('meta[name="description"]'))==null?void 0:w.getAttribute("content"),v=(g=document.querySelector('meta[name="author"]'))==null?void 0:g.getAttribute("content"),a=(y=document.querySelector('meta[name="twitter:description"]'))==null?void 0:y.getAttribute("content");S=P||S,A=u||x||a||"",E=v||"",i=n||"",b=C||"";const s=['meta[property="article:published_time"]','meta[name="publication_date"]','meta[name="date"]',"time[datetime]","[datetime]"];for(const q of s){const k=document.querySelector(q);if(k){o=k.getAttribute("content")||k.getAttribute("datetime")||k.textContent||"";break}}const f=["article","main",'[role="main"]',".post-content",".entry-content",".article-content",".blog-content",".blog-post",".post-body",".post",".content",".main-content",".page-content",".story-content",".single-content","#content","#main","#main-content","#post","#article","#post-content",'[itemprop="articleBody"]','[itemprop="text"]',".wp-content",".the-content",".section-content",".post-full-content"];let T=null;for(const q of f){if(T=document.querySelector(q),T&&T.textContent&&T.textContent.trim().length>100)break;T=null}if(T){const q=T.cloneNode(!0);["script","style","nav","header","footer","aside",".ads",".advertisement",".social",".share",".sidebar",".comments",".comment",".related",".recommended",'[class*="ad-"]','[class*="ads-"]','[id*="ad-"]',"#secondary","#related","#comments",".ytd-compact-video-renderer",".ytd-watch-next-secondary-results-renderer",'[class*="ytp-endscreen"]',".ytd-item-section-renderer",".ytd-shelf-renderer","#playlist",".ytd-merch-shelf-renderer",".ytd-watch-flexy #secondary-inner",".ytd-watch-next-secondary-results-renderer"].forEach(I=>{try{q.querySelectorAll(I).forEach(_=>_.remove())}catch{}}),d=((p=q.textContent)==null?void 0:p.trim())||""}if(!d||d.length<100){const q=document.body.cloneNode(!0);q.querySelectorAll("script, style, nav, header, footer, aside, noscript, iframe, svg, img, video, audio").forEach(I=>I.remove());const k=document.createElement("div");k.innerHTML=q.innerHTML,document.body.appendChild(k),d=((m=k.innerText)==null?void 0:m.trim())||"",k.remove(),(!d||d.length<50)&&(d=((c=document.body.innerText)==null?void 0:c.trim())||"")}return d.length>15e3&&(d=d.substring(0,15e3)+"..."),{success:!0,title:S,content:d,description:A,author:E,publishDate:o,ogImage:i,siteName:b,language:L}}catch(d){try{return{success:!0,title:document.title,content:((l=document.body.innerText)==null?void 0:l.substring(0,15e3))||"",description:"",author:"",publishDate:"",ogImage:"",siteName:"",language:"fr"}}catch{return{success:!1,error:d instanceof Error?d.message:"Erreur extraction contenu"}}}}function z(){var r,e,t,h,w,g,y,p,m;try{const c=(r=document.querySelector('meta[name="description"]'))==null?void 0:r.getAttribute("content"),l=(e=document.querySelector('meta[property="og:description"]'))==null?void 0:e.getAttribute("content"),d=document.querySelectorAll("article p, main p, .content p, .post-content p, .entry-content p, p");let S="";for(const a of d){const s=((t=a.textContent)==null?void 0:t.trim())||"";if(s.length>80){S=s.slice(0,400);break}}const A=l||c||S||document.title,E=document.querySelector("article")||document.querySelector("main")||document.querySelector('[role="main"]')||document.querySelector(".post-content")||document.querySelector(".entry-content")||document.querySelector(".article-content")||document.querySelector(".blog-content")||document.querySelector("#content"),o=["related","comments","share","subscribe","newsletter","suivez","partager","also read","see also","à lire","menu","navigation","footer","header","sidebar","contact","about","à propos","instagram","facebook","twitter","tiktok","linkedin","youtube","pinterest","snapchat","discord","whatsapp","telegram","publications recommandées","articles similaires","articles récents","recommended","popular posts","trending","recent posts","archives","catégories","categories","tags","recherche","search","widget"],i=a=>{const s=a.toLowerCase();return o.some(f=>s.includes(f))};let b=[];if(E&&(b=Array.from(E.querySelectorAll("h2, h3")).map(a=>{var s;return(s=a.textContent)==null?void 0:s.trim()}).filter(a=>!!a&&a.length>5&&a.length<150&&!i(a)).slice(0,8)),b.length===0){const a=(E||document).querySelectorAll("p");b=Array.from(a).map(s=>{var f;return(f=s.textContent)==null?void 0:f.trim()}).filter(s=>!!s&&s.length>80&&!i(s)).slice(0,5).map(s=>{var T;const f=(T=s.match(/^[^.!?]+[.!?]/))==null?void 0:T[0];return(f==null?void 0:f.trim())||s.slice(0,120)+"..."})}const L=Array.from(document.querySelectorAll("article strong, article b, main strong, main b, .content strong, .content b")).map(a=>{var s;return(s=a.textContent)==null?void 0:s.trim()}).filter(a=>!!a&&a.length>2&&a.length<60),P=Array.from(document.querySelectorAll("article a, main a, .content a")).map(a=>{var s;return(s=a.textContent)==null?void 0:s.trim()}).filter(a=>!!a&&a.length>3&&a.length<50&&!a.startsWith("http")),u=[...new Set([...L,...P])].slice(0,10),n=(h=document.querySelector('meta[name="keywords"]'))==null?void 0:h.getAttribute("content");let C=[];if(n&&(C=n.split(",").map(a=>a.trim().toLowerCase()).filter(a=>a.length>1&&a.length<30)),C.length===0){const a=document.querySelectorAll('.tag, .tags a, .category, .categories a, [rel="tag"]');C=Array.from(a).map(s=>{var f;return(f=s.textContent)==null?void 0:f.trim().toLowerCase()}).filter(s=>!!s&&s.length>1&&s.length<30)}C=[...new Set(C)].slice(0,6);let x="";const v=["article","main",'[role="main"]',".post-content",".entry-content",".content","#content"];for(const a of v){const s=document.querySelector(a);if(s){const f=s.cloneNode(!0);if(["script","style","nav","aside","footer",".ads",".comments","#secondary","#related",".ytd-compact-video-renderer",".ytd-watch-next-secondary-results-renderer",'[class*="ytp-endscreen"]',".ytd-item-section-renderer",".ytd-shelf-renderer","#playlist",".ytd-merch-shelf-renderer"].forEach(q=>{try{f.querySelectorAll(q).forEach(k=>k.remove())}catch{}}),x=((w=f.textContent)==null?void 0:w.trim())||"",x.length>100)break}}return(!x||x.length<100)&&(x=((g=document.body.innerText)==null?void 0:g.trim())||""),x.length>1e4&&(x=x.substring(0,1e4)+"..."),{success:!0,title:document.title,content:x,summary:A,keyPoints:b,concepts:u,tags:C,description:l||c||"",author:((y=document.querySelector('meta[name="author"]'))==null?void 0:y.getAttribute("content"))||"",ogImage:((p=document.querySelector('meta[property="og:image"]'))==null?void 0:p.getAttribute("content"))||"",siteName:((m=document.querySelector('meta[property="og:site_name"]'))==null?void 0:m.getAttribute("content"))||""}}catch(c){return{success:!1,error:c instanceof Error?c.message:"Erreur extraction"}}}async function B(r){var e,t,h,w,g;try{const y=await chrome.tabs.get(r),p=y.url||"",m=p.includes("youtube.com/watch")||p.includes("youtu.be/");let c=y.title||"Page sans titre",l="",d="",S=[],A=[],E=[],o="",i="",b="",L="";if(m)try{const u=await chrome.scripting.executeScript({target:{tabId:r},func:W}),n=(e=u==null?void 0:u[0])==null?void 0:e.result;n&&(c=n.title||c,i=n.author||"",o=n.description||"",n.chapters&&n.chapters.length>0?S=n.chapters.slice(0,8):n.transcriptKeyPoints&&n.transcriptKeyPoints.length>0?S=n.transcriptKeyPoints:n.descriptionKeyPoints&&n.descriptionKeyPoints.length>0&&(S=n.descriptionKeyPoints),l=n.transcript||n.description||"",d=i?`Vidéo de ${i}: ${c}`:c)}catch(u){console.warn("YouTube extraction failed:",u)}if(!m&&(!l||l.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:r},func:z}),n=(t=u==null?void 0:u[0])==null?void 0:t.result;n!=null&&n.success&&(c=n.title||c,l=n.content||"",d=n.summary||"",S=n.keyPoints||[],A=n.concepts||[],E=n.tags||[],o=n.description||"",i=n.author||"",b=n.ogImage||"",L=n.siteName||"")}catch(u){console.warn("Structured extraction failed:",u)}if(!m&&(!l||l.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:r},func:()=>{var C,x;return{text:((x=(C=document.body)==null?void 0:C.innerText)==null?void 0:x.trim())||"",title:document.title}}}),n=(h=u==null?void 0:u[0])==null?void 0:h.result;n!=null&&n.text&&n.text.length>50&&(l=n.text.substring(0,1e4),c=n.title||c,d=l.slice(0,300))}catch(u){console.warn("Simple extraction failed:",u)}if(m&&(!l||l.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:r},func:()=>{var a,s,f,T,q;const C=(a=document.querySelector('meta[property="og:title"]'))==null?void 0:a.getAttribute("content"),x=(s=document.querySelector('meta[property="og:description"]'))==null?void 0:s.getAttribute("content"),v=((f=document.querySelector('link[itemprop="name"]'))==null?void 0:f.getAttribute("content"))||((q=(T=document.querySelector("#channel-name"))==null?void 0:T.textContent)==null?void 0:q.trim());return{ogTitle:C,ogDesc:x,channelName:v}}}),n=(w=u==null?void 0:u[0])==null?void 0:w.result;n&&(c=n.ogTitle||c,o=n.ogDesc||o,i=n.channelName||i,l=o||c,d=i?`Vidéo de ${i}: ${c}`:`Vidéo YouTube: ${c}`)}catch(u){console.warn("YouTube meta extraction failed:",u)}if(m&&(!l||l.length<50))try{const u=await chrome.scripting.executeScript({target:{tabId:r},func:()=>{var a,s,f;const C=document.title;if(C&&C!=="YouTube"&&C.length>8)return C.replace(/\s*-\s*YouTube$/i,"").trim();const x=(a=document.querySelector('meta[property="og:title"]'))==null?void 0:a.getAttribute("content");if(x)return x;const v=(f=(s=document.querySelector("h1"))==null?void 0:s.textContent)==null?void 0:f.trim();return v&&v!=="YouTube"&&v.length>3?v:null}}),n=(g=u==null?void 0:u[0])==null?void 0:g.result;n&&(c=n,l=n,d=`Vidéo YouTube: ${n}`)}catch(u){console.warn("YouTube title extraction failed:",u)}if(m&&(!c||c==="YouTube"||c==="Page sans titre")&&(d="Vidéo YouTube (titre non disponible - attendez le chargement complet)",l=d,c="Vidéo YouTube"),!m&&(!l||l.length<50))return{success:!1,error:"Contenu insuffisant. Vérifiez que la page est bien chargée."};let P="";try{P=new URL(p).hostname.replace("www.","")}catch{}return{success:!0,content:l,pageTitle:c,url:p,favicon:y.favIconUrl||"",domain:P,isYouTube:m,contentType:Y(p,c),summary:d,keyPoints:S,concepts:A,tags:E,description:o,author:i,ogImage:b,siteName:L}}catch(y){return console.error("Error in smart capture:",y),{success:!1,error:y instanceof Error?y.message:"Erreur lors de la capture intelligente"}}}function W(){var r,e,t,h;try{let w="";const g=document.querySelector("h1.ytd-watch-metadata yt-formatted-string")||document.querySelector("#title h1")||document.querySelector("h1.title")||document.querySelector('[itemprop="name"]');if((r=g==null?void 0:g.textContent)!=null&&r.trim()&&(w=g.textContent.trim()),!w){const o=(e=document.querySelector('meta[property="og:title"]'))==null?void 0:e.getAttribute("content");o&&(w=o)}if(!w){const o=document.title;o&&o!=="YouTube"&&o.length>8&&(w=o.replace(/\s*-\s*YouTube$/i,"").trim())}w||(w="");const y=document.querySelector("#channel-name a")||document.querySelector(".ytd-channel-name a"),p=((t=y==null?void 0:y.textContent)==null?void 0:t.trim())||"",m=document.querySelector("#description-inline-expander yt-formatted-string")||document.querySelector("#description yt-formatted-string")||document.querySelector("#description"),c=((h=m==null?void 0:m.textContent)==null?void 0:h.trim())||"";let l="";const d=document.querySelectorAll("ytd-transcript-segment-renderer .segment-text,ytd-transcript-segment-renderer yt-formatted-string");if(d.length>0&&(l=Array.from(d).map(o=>{var i;return(i=o.textContent)==null?void 0:i.trim()}).filter(Boolean).join(" ")),!l){const o=document.querySelectorAll(".captions-text, .ytp-caption-segment");o.length>0&&(l=Array.from(o).map(i=>{var b;return(b=i.textContent)==null?void 0:b.trim()}).filter(Boolean).join(" "))}const S=[];if(c){const o=/(?:\[?\d{1,2}:\d{2}(?::\d{2})?\]?\s*[-–]?\s*)([^\n]+)/g;let i;for(;(i=o.exec(c))!==null;){const b=i[1].trim();b.length>3&&b.length<100&&S.push(b)}}let A=[];if(l&&l.length>200){const o=l.split(/[.!?]+/).map(i=>i.trim()).filter(i=>i.length>40&&i.length<200&&!i.toLowerCase().includes("subscribe")&&!i.toLowerCase().includes("like this video")&&!i.toLowerCase().includes("click the bell")&&!i.toLowerCase().includes("hit the like")&&!i.toLowerCase().includes("leave a comment")&&!i.toLowerCase().includes("check out my")&&!i.toLowerCase().includes("link in the description")&&!i.toLowerCase().includes("abonnez")&&!i.toLowerCase().includes("likez"));if(o.length>0){const i=Math.max(1,Math.floor(o.length/5));for(let b=0;b<o.length&&A.length<5;b+=i)A.push(o[b].slice(0,150))}}let E=[];return c&&A.length===0&&S.length===0&&(E=c.split(`
`).map(o=>o.trim()).filter(o=>o.length>30&&o.length<150&&!o.startsWith("http")&&!o.match(/^\d{1,2}:\d{2}/)&&!o.toLowerCase().includes("subscribe")&&!o.toLowerCase().includes("follow me")&&!o.toLowerCase().includes("instagram")&&!o.toLowerCase().includes("twitter")&&!o.toLowerCase().includes("discord")&&!o.toLowerCase().includes("patreon")).slice(0,5)),{title:w,author:p,description:c,transcript:l||"",chapters:S,transcriptKeyPoints:A,descriptionKeyPoints:E}}catch{return{title:document.title,author:"",description:"",transcript:"",chapters:[],transcriptKeyPoints:[]}}}function Y(r,e){return r.includes(".pdf")?"pdf":r.includes("youtube.com")||r.includes("youtu.be")?"video":e.toLowerCase().includes("research")||e.toLowerCase().includes("study")||e.toLowerCase().includes("journal")?"research-paper":r.includes("docs.")||r.includes("documentation")?"documentation":r.includes("article")||r.includes("blog")?"article":"webpage"}N();
